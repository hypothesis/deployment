# ebextension to deliver a custom nginx configuration.
# The is the default nginx.conf as found on a QA instance running on the `t3a.small` instance type.
# The only change is to the worker_connections which has been increased to 4096
files:
  "/etc/nginx/nginx.conf" :
    mode: "000644"
    owner: root
    group: root
    content: |
      # Custom Elastic Beanstalk Nginx Configuration File
      # Delivered by ebextension 80_nginx_workers.config

      user  nginx;
      worker_processes  auto;
      worker_rlimit_nofile    65936;

      error_log  /var/log/nginx/error.log;

      pid        /var/run/nginx.pid;

      events {
          worker_connections  4096;
      }

      http {
          include       /etc/nginx/mime.types;
          default_type  application/octet-stream;

          access_log    /var/log/nginx/access.log;

          log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                                '$status $body_bytes_sent "$http_referer" '
                                '"$http_user_agent" "$http_x_forwarded_for"';

          include       /etc/nginx/conf.d/*.conf;
          
          map $http_upgrade $connection_upgrade {
                  default       "upgrade";
          }

          server {
              listen 80 default_server;
              gzip on;
              gzip_comp_level 4;
              gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
              access_log    /var/log/nginx/access.log main;

              location / {
                  proxy_pass            http://docker;
                  proxy_http_version    1.1;
                   
                  proxy_set_header    Connection             $connection_upgrade;
                  proxy_set_header    Upgrade                $http_upgrade;          
                  proxy_set_header    Host                   $host;
                  proxy_set_header    X-Real-IP              $remote_addr;
                  proxy_set_header    X-Forwarded-For        $proxy_add_x_forwarded_for;
              }
    
              # Include the Elastic Beanstalk generated locations
              include conf.d/elasticbeanstalk/*.conf;
          
         }
      }
