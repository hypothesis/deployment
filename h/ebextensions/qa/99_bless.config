## Configure a server to accecpt SSH certificates signed by our BLESS lambda service.

services:
  sysvinit:
    sshd:
      enabled: "true"
      ensureRunning: "true"
      files:
        - "/etc/ssh/sshd_config"

groups:
  ssh_access: {}

files:
  "/etc/ssh/cas.pub":
    mode: "00444"
    owner: root
    group: root
    encoding: plain
    content: |
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCxK1zWz8DWLexhnHAtLtphoECUd8rRX/g4fVpsYPp7aUdPBeT63n7IykX7KfZTBFIHsUuzBffAL1Re4UuE6dyUDZGdkPCjmTuksqxPV5iP46EmNx9VN/2s8SiSWVWJNV/1Ixk9INpMw9Km7dETJKOFPgRN4nZKI5rMLtoESKidY/eDhK/fmqwn1hdZUngCxpYr4D1bzZLmeLrJrkxPwbKhX0busCUYB/ePOuhMp53eb9v9o2qF3IthmqIxKitCiCW9G5Auzix4qUvxRi6wDdW0DQ4s0J4s4EYj951KdI0+0aExllM3IVZQYWY3I5DUjJlqZA/Vg90x/cyl3eFqcN2GRfH2mHdjtEq32Txdqg1GYG3MMAseC3DWT4LxWs2gcZp5cql2p7VBhgM/WO17igHKH0xFwCubTbVWNStDO1JlbmobK6dRtKjQvL24QvFAVm6oxRO5GV5nZfR52moSc58unZvM+LxIB+hm9WDMqlvk12GP84FRaPyhSOq8VEelQ1ZFqtD4u5aITRc+pOINZtBDkCUAdDATfRBolLI+I5jGaVW+qVEStibjbR3pu1//FvwnVszjWVVDEP7ovkCN0njbGDlrCbfb8YMT03FcSk6mPqxQkzQnvBtqIF3anIVG7vjK5rfiyXkQVANES3xan5l0vhqAzj+wjY2Hik+tNEcn8Q== Bless_CA

  "/etc/sudoers.d/91-bless-users":
    mode: "00440"
    owner: root
    group: root
    encoding: plain
    content: |
      %ssh_access   ALL=(ALL:ALL) ALL

  "/etc/ssh/sshd_config":
    mode: "00600"
    owner: root
    group: root
    encoding: plain
    content: |
      # This is the sshd server system-wide configuration file.  See
      # sshd_config(5) for more information.
      TrustedUserCAKeys /etc/ssh/cas.pub
      HostKey /etc/ssh/ssh_host_rsa_key
      HostKey /etc/ssh/ssh_host_ecdsa_key
      HostKey /etc/ssh/ssh_host_ed25519_key
      SyslogFacility AUTHPRIV
      PermitRootLogin forced-commands-only
      AuthorizedKeysFile .ssh/authorized_keys
      PasswordAuthentication no
      ChallengeResponseAuthentication no
      UsePAM yes
      X11Forwarding no
      PrintLastLog yes
      UsePrivilegeSeparation sandbox
      AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
      AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
      AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE
      AcceptEnv XMODIFIERS


## The canonical source of iamsync.py is kept in the ansible ssh playbook
  "/usr/local/bin/iamsync.py":
    mode: "00600"
    owner: root
    group: root
    encoding: base64
    content: |
      IiIiCmlhbXN5bmMucHkKR2l2ZW4gYW4gSUFNIHBhdGggcHJlZml4LCB0aGlzIHNjcmlwdCB3aWxsIGZldGNoIGEgbGlzdCBvZiBncm91cHMgaW4gdGhhdCBwYXRoCmFuZCB0aGVuIGZldGNoIHRoZSBtZW1iZXJzIG9mIHRob3NlIGdyb3VwcyBhbmQgZW5zdXJlIHRoYXQgdGhleSBtYXRjaCB0aGUgbWVtYmVycwppbiB0aGUgbWF0Y2hpbmcgbG9jYWwgdW5peCBncm91cHMuClVzYWdlOgogICAgaWFtc3luYy5weSBbLS1JQU1fUGF0aF9QcmVmaXhdIFstLWxvZ3BhdGg9Jy9wYXRoJ10gWy0tZHJ5cnVuXQoiIiIKCmltcG9ydCBib3RvMywgcHdkLCBncnAsIGxvZ2dpbmcsIGxvZ2dpbmcuaGFuZGxlcnMsIHN1YnByb2Nlc3MsIGFyZ3BhcnNlCgpwYXJzZXIgPSBhcmdwYXJzZS5Bcmd1bWVudFBhcnNlcigKICAgIGRlc2NyaXB0aW9uPSJTeW5jIElBTSBzc2ggZ3JvdXAgdXNlcnMgdG8gbG9jYWwgbGludXggYWNjb3VudHMiCikKcGFyc2VyLmFkZF9hcmd1bWVudCgKICAgICItLXBhdGhwcmVmaXgiLAogICAgcmVxdWlyZWQ9RmFsc2UsCiAgICB0eXBlPXN0ciwKICAgIG5hcmdzPTEsCiAgICBkZWZhdWx0PSIvaWFtc3luYy8iLAogICAgaGVscD0icGF0aCBvZiB0aGUgSUFNIGdyb3VwIHRvIHdoaWNoIHNzaC1lbmFibGVkIHVzZXJzIGJlbG9uZyIsCikKcGFyc2VyLmFkZF9hcmd1bWVudCgKICAgICItLWxvZ3BhdGgiLAogICAgdHlwZT1zdHIsCiAgICBkZWZhdWx0PSIvdG1wL2lhbXN5bmMubG9nIiwKICAgIHJlcXVpcmVkPUZhbHNlLAogICAgaGVscD0icGF0aCBmb3IgbG9nZ2luZyIsCikKcGFyc2VyLmFkZF9hcmd1bWVudCgKICAgICItLWRyeXJ1biIsCiAgICBhY3Rpb249InN0b3JlX3RydWUiLAogICAgaGVscD0iZG8gbm90IGNyZWF0ZSBvciBkZWxldGUgYWNjb3VudHMsIG9ubHkgcmVwb3J0IHdoYXQgYWN0aW9ucyB3b3VsZCBiZSB0YWtlbiIsCikKYXJncyA9IHBhcnNlci5wYXJzZV9hcmdzKCkKCgpfTE9HR0VSID0gbG9nZ2luZy5nZXRMb2dnZXIoInB5dGhvbkxvZ2dlciIpCgoKZGVmIGdldF9sb2NhbF9ncm91cF9tZW1iZXJzaGlwKGdyb3VwbmFtZSk6CiAgICB0cnk6CiAgICAgICAgcmV0dXJuIGdycC5nZXRncm5hbShncm91cG5hbWUpWzNdCiAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgcHJpbnQoIkdyb3VwIHt9IGRvZXMgbm90IGV4aXN0LiIuZm9ybWF0KGdyb3VwbmFtZSkpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgX0xPR0dFUi5lcnJvcihlKQoKCmRlZiBnZXRfaWFtX2dyb3VwcyhwYXRocHJlZml4KToKICAgICMgQ29uc3RydWN0IGEgbGlzdCBvZiBJQU0gZ3JvdXBzIHRvIHN5bmMgYnkgbGlzdGluZyBhbGwgZ3JvdXBzIHByZXNlbnQKICAgICMgYXQgdGhlIGRlc2lnbmF0ZWQgSUFNIHBhdGggcHJlZml4CiAgICB0cnk6CiAgICAgICAgaWFtZ3JvdXBzID0gW10KICAgICAgICBpYW0gPSBib3RvMy5jbGllbnQoImlhbSIpCiAgICAgICAgZ3JvdXBzID0gaWFtLmxpc3RfZ3JvdXBzKFBhdGhQcmVmaXg9cGF0aHByZWZpeCkKICAgICAgICBmb3IgZyBpbiBncm91cHNbIkdyb3VwcyJdOgogICAgICAgICAgICBpYW1ncm91cHMuYXBwZW5kKGdbIkdyb3VwTmFtZSJdKQogICAgICAgIHJldHVybiBpYW1ncm91cHMKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBfTE9HR0VSLmVycm9yKGUpCgoKZGVmIHJlbW92ZV9kZWZ1bmN0X3VzZXJzKGdyb3Vwcyk6CiAgICBhbGx1c2VycyA9IHB3ZC5nZXRwd2FsbCgpCiAgICBkZWZ1bmN0ID0gW10KICAgIHRyeToKICAgICAgICBmb3IgdSBpbiBhbGx1c2VyczoKICAgICAgICAgICAgZGVsZXRlID0gRmFsc2UKICAgICAgICAgICAgIyBzZXQgZGVsZXRlIHRvIFRydWUgaWYgdGhlIHVzZXIncyBjb21tZW50IGlzIGlhbXN5bmMKICAgICAgICAgICAgaWYgcHdkLmdldHB3bmFtKHUucHdfbmFtZSkucHdfZ2Vjb3MgPT0gImlhbXN5bmMiOgogICAgICAgICAgICAgICAgZGVsZXRlID0gVHJ1ZQoKICAgICAgICAgICAgIyBDaGVjayBlYWNoIGdyb3VwJ3MgbWVtYmVyc2hpcCBmb3IgdGhlIHVzZXIKICAgICAgICAgICAgIyBJZiBhbnkgZ3JvdXAgaGFzIHRoYXQgdXNlciBhcyBhIG1lbWJlciwgc2V0IGRlbGV0ZSB0byBGYWxzZQogICAgICAgICAgICBmb3IgZyBpbiBncm91cHM6CiAgICAgICAgICAgICAgICBpZiB1LnB3X25hbWUgaW4gZ3JwLmdldGdybmFtKGcpLmdyX21lbToKICAgICAgICAgICAgICAgICAgICBkZWxldGUgPSBGYWxzZQoKICAgICAgICAgICAgIyBJZiBkZWxldGUgaXMgVHJ1ZSwgYWRkIHRvIGxpc3Qgb2YgZGVmdW5jdCB1c2VycwogICAgICAgICAgICBpZiBkZWxldGU6CiAgICAgICAgICAgICAgICBkZWZ1bmN0LmFwcGVuZCh1LnB3X25hbWUpCiAgICAgICAgaWYgZGVmdW5jdDoKICAgICAgICAgICAgX0xPR0dFUi5pbmZvKCJEZWZ1bmN0IFVzZXJzOiB7fSIuZm9ybWF0KGRlZnVuY3QpKQoKICAgICAgICBmb3IgdSBpbiBkZWZ1bmN0OgogICAgICAgICAgICBwcmludCgiUmVtb3ZlIHVzZXI6IHt9Ii5mb3JtYXQodSkpCiAgICAgICAgICAgIGlmIG5vdCBhcmdzLmRyeXJ1bjoKICAgICAgICAgICAgICAgIGV4aXRjb2RlID0gc3VicHJvY2Vzcy5jYWxsKFsidXNlcmRlbCIsICItLXJlbW92ZSIsIHVdKQogICAgICAgICAgICAgICAgX0xPR0dFUi5pbmZvKAogICAgICAgICAgICAgICAgICAgICJSZW1vdmluZyB1c2VyIHt9IGFuZCBob21lIGRpcmVjdG9yeSBleGl0ZWQgd2l0aCBjb2RlIHt9Ii5mb3JtYXQoCiAgICAgICAgICAgICAgICAgICAgICAgIHUsIGV4aXRjb2RlCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIF9MT0dHRVIuZXJyb3IoZSkKCgpkZWYgY3JlYXRlX3VzZXIodXNlcm5hbWUsIGdyb3VwKToKICAgIHRyeToKICAgICAgICBob21lZGlyID0gIi9ob21lL3t9Ii5mb3JtYXQodXNlcm5hbWUpCiAgICAgICAgZXhpdGNvZGUgPSBzdWJwcm9jZXNzLmNhbGwoCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICJ1c2VyYWRkIiwKICAgICAgICAgICAgICAgICItcyIsCiAgICAgICAgICAgICAgICAiL2Jpbi9iYXNoIiwKICAgICAgICAgICAgICAgICItYyIsCiAgICAgICAgICAgICAgICAiaWFtc3luYyIsCiAgICAgICAgICAgICAgICAiLW1kIiwKICAgICAgICAgICAgICAgIGhvbWVkaXIsCiAgICAgICAgICAgICAgICAiLWciLAogICAgICAgICAgICAgICAgZ3JvdXAsCiAgICAgICAgICAgICAgICB1c2VybmFtZSwKICAgICAgICAgICAgXQogICAgICAgICkKICAgICAgICBfTE9HR0VSLmluZm8oCiAgICAgICAgICAgICJDcmVhdGluZyB1c2VyIHt9IHdpdGggcHJpbWFyeSBncm91cCB7fSBleGl0ZWQgd2l0aCBjb2RlIHt9Ii5mb3JtYXQoCiAgICAgICAgICAgICAgICB1c2VybmFtZSwgZ3JvdXAsIGV4aXRjb2RlCiAgICAgICAgICAgICkKICAgICAgICApCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgX0xPR0dFUi5lcnJvcihlKQoKCmRlZiBjaGVja19pZl91c2VyX2V4aXN0cyh1c2VybmFtZSk6CiAgICB0cnk6CiAgICAgICAgY2hlY2sgPSBwd2QuZ2V0cHduYW0odXNlcm5hbWUpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICByZXR1cm4gRmFsc2UKCgpkZWYgcmVtb3ZlX3VzZXJfZnJvbV9ncm91cCh1c2VybmFtZSwgZ3JvdXBuYW1lKToKICAgIHRyeToKICAgICAgICBzdWJwcm9jZXNzLmNhbGwoWyJncGFzc3dkIiwgIi1kIiwgdXNlcm5hbWUsIGdyb3VwbmFtZV0pCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgX0xPR0dFUi5lcnJvcihlKQoKCmRlZiBhZGRfdXNlcl90b19ncm91cCh1c2VybmFtZSwgZ3JvdXBuYW1lKToKICAgIHRyeToKICAgICAgICBleGl0Y29kZSA9IHN1YnByb2Nlc3MuY2FsbChbInVzZXJtb2QiLCAiLWFHIiwgZ3JvdXBuYW1lLCB1c2VybmFtZV0pCiAgICAgICAgX0xPR0dFUi5pbmZvKAogICAgICAgICAgICAiQWRkaW5nIHVzZXIge30gdG8gZ3JvdXAge30gZXhpdGVkIHdpdGggY29kZSB7fSIuZm9ybWF0KAogICAgICAgICAgICAgICAgdXNlcm5hbWUsIGdyb3VwbmFtZSwgZXhpdGNvZGUKICAgICAgICAgICAgKQogICAgICAgICkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBfTE9HR0VSLmVycm9yKGUpCgoKZGVmIGdldF9pYW1fZ3JvdXBfbWVtYmVyc2hpcChncm91cG5hbWUpOgogICAgdHJ5OgogICAgICAgIHVzZXJzID0gW10KICAgICAgICBpYW0gPSBib3RvMy5yZXNvdXJjZSgiaWFtIikKICAgICAgICBncm91cCA9IGlhbS5Hcm91cChncm91cG5hbWUpCiAgICAgICAgZm9yIHUgaW4gZ3JvdXAudXNlcnMuYWxsKCk6CiAgICAgICAgICAgIHVzZXJzLmFwcGVuZCh1Lm5hbWUpCiAgICAgICAgcmV0dXJuIHVzZXJzCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgX0xPR0dFUi5lcnJvcihlKQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CgogICAgcGF0aHByZWZpeCA9IGFyZ3MucGF0aHByZWZpeAogICAgbG9ncGF0aCA9IGFyZ3MubG9ncGF0aAoKICAgIF9MT0dHRVIuc2V0TGV2ZWwobG9nZ2luZy5JTkZPKQogICAgcHlfaGRsciA9IGxvZ2dpbmcuaGFuZGxlcnMuV2F0Y2hlZEZpbGVIYW5kbGVyKGxvZ3BhdGgsIG1vZGU9ImEiKQogICAgcHlfZm9ybWF0dGVyID0gbG9nZ2luZy5Gb3JtYXR0ZXIoIiUoYXNjdGltZSlzIDogJShsZXZlbG5hbWUpcyAtICUobWVzc2FnZSlzIikKICAgIHB5X2hkbHIuc2V0Rm9ybWF0dGVyKHB5X2Zvcm1hdHRlcikKICAgIF9MT0dHRVIuYWRkSGFuZGxlcihweV9oZGxyKQoKICAgIF9MT0dHRVIuaW5mbygiRXhlY3V0aW5nIHdpdGggcGF0aHByZWZpeCB7fSIuZm9ybWF0KHBhdGhwcmVmaXgpKQoKICAgIGlhbWdyb3VwcyA9IGdldF9pYW1fZ3JvdXBzKHBhdGhwcmVmaXgpCgogICAgZm9yIGdyb3VwIGluIGlhbWdyb3VwczoKCiAgICAgICAgIyBEZXRlcm1pbmUgbWVtYmVyc2hpcHMgaW4gSUFNIGFuZCBsb2NhbGx5CiAgICAgICAgaWFtdXNlcnMgPSBnZXRfaWFtX2dyb3VwX21lbWJlcnNoaXAoZ3JvdXApCgogICAgICAgIGxvY2FsdXNlcnMgPSBnZXRfbG9jYWxfZ3JvdXBfbWVtYmVyc2hpcChncm91cCkKCiAgICAgICAgIyBMaXN0IG9mIHVzZXJzIHdlIHdhbnQgdG8gcHVyZ2UgZnJvbSB0aGUgZ3JvdXAKICAgICAgICBzdWJ0cmFjdCA9IFtdCgogICAgICAgICMgSWYgdXNlciBleGlzdHMgbG9jYWxseSBidXQgaXMgbm90IGluIElBTSBncm91cAogICAgICAgICMgQWRkIHRvIHN1YnRyYWN0IGxpc3QKICAgICAgICBmb3IgdSBpbiBsb2NhbHVzZXJzOgogICAgICAgICAgICBpZiB1IG5vdCBpbiBpYW11c2VyczoKICAgICAgICAgICAgICAgIHN1YnRyYWN0LmFwcGVuZCh1KQoKICAgICAgICAjIFBlcmZvcm0gc3VidHJhY3Rpb24KICAgICAgICBpZiBzdWJ0cmFjdDoKICAgICAgICAgICAgZm9yIHUgaW4gc3VidHJhY3Q6CiAgICAgICAgICAgICAgICByZW1vdmVfdXNlcl9mcm9tX2dyb3VwKHUsIGdyb3VwKQoKICAgICAgICAjIElmIHVzZXIgZXhpc3RzIGluIElBTSBidXQgbm90IGxvY2FsbHksIGNyZWF0ZSBhbmQgYXBwZW5kIHRvIGdyb3VwCiAgICAgICAgZm9yIHUgaW4gaWFtdXNlcnM6CiAgICAgICAgICAgIGlmIHUgbm90IGluIGxvY2FsdXNlcnM6CiAgICAgICAgICAgICAgICBpZiBub3QgY2hlY2tfaWZfdXNlcl9leGlzdHModSk6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIkNyZWF0ZSB1c2VyIHt9Ii5mb3JtYXQodSkpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGFyZ3MuZHJ5cnVuOgogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVfdXNlcih1LCBncm91cCkKICAgICAgICAgICAgICAgICAgICAgICAgYWRkX3VzZXJfdG9fZ3JvdXAodSwgZ3JvdXApCgogICAgcmVtb3ZlX2RlZnVuY3RfdXNlcnMoaWFtZ3JvdXBzKQo=

commands:
  98_boto3:
    command: pip install boto3
  99_iamsync:
    command: /usr/bin/python /usr/local/bin/iamsync.py
    ignoreErrors: True
